---
- hosts: all
  become: yes
  tasks:
  - name: Upgrade
    apt:
      upgrade: full
  - name: Remove cdrom entry from /etc/apt/sources.list
    lineinfile:
      path: /etc/apt/sources.list
      regexp: "^deb cdrom"
      state: absent
  - name: Install linux-headers
    package:
      name: "{{ item }}"
      state: present
    loop:
      - linux-headers-{{ ansible_kernel }}
      - build-essential
  - name: Mount cdrom
    mount:
      src: /home/vagrant/VBoxGuestAdditions.iso
      path: /mnt
      opts: loop
      state: mounted
      fstype: iso9660
  - name: Install 
    shell: REMOVE_INSTALLATION_DIR=0 /mnt/VBoxLinuxAdditions.run
    failed_when: false
  - name: Unmount cdrom
    mount:
      path: /mnt
      state: unmounted
  - name: Remove linux-headers
    package:
      name: "{{ item }}"
      state: absent
    loop:
      - linux-headers-{{ ansible_kernel }}
      - build-essential
  - name: Clear apt cache
    shell: apt-get clean
  - name: Create empty file
    shell: |
      dd if=/dev/zero of=/EMPTY
      rm /EMPTY -rf
    failed_when: false
  - name: Cleanup
    file:
      path: /EMPTY
      state: absent
  - include: ./reduce-debian.yaml
